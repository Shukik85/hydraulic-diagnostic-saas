name: Hybrid Bot Operations

permissions:
  issues: write
  pull-requests: write
  contents: read

on:
  issue_comment:
    types: [created]

concurrency:
  group: bot-operations-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  bot-hybrid:
    name: Bot Hybrid Operations
    runs-on: ubuntu-latest
    if: >
      github.event.issue.pull_request &&
      github.actor == 'Shukik85' &&
      (
        contains(github.event.comment.body, '/start-session') ||
        contains(github.event.comment.body, '/approve') ||
        contains(github.event.comment.body, '/rollback') ||
        contains(github.event.comment.body, '/bot-status')
      )
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Parse command
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          echo "full_comment=${COMMENT}" >> $GITHUB_OUTPUT
          
          echo "ğŸ” Debug: Full comment received:"
          echo "$COMMENT"
          
          # Extract command type with better matching
          if echo "$COMMENT" | grep -q '/start-session'; then
            echo "command=start-session" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/approve'; then
            echo "command=approve" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/rollback'; then
            echo "command=rollback" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/bot-status'; then
            echo "command=status" >> $GITHUB_OUTPUT
          else
            echo "command=unknown" >> $GITHUB_OUTPUT
          fi
          
          # Extract JSON payload if present
          JSON_PAYLOAD=$(echo "$COMMENT" | grep -o '{[^}]*}' || echo "{}")
          echo "json_payload=${JSON_PAYLOAD}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Parsed command: $(cat $GITHUB_OUTPUT | grep command=)"
          echo "ğŸ“‹ Parsed payload: $JSON_PAYLOAD"
          
      - name: Validate permissions
        run: |
          echo "âœ… Command from authorized user: ${{ github.actor }}"
          echo "ğŸ“ Command: ${{ steps.parse.outputs.command }}"
          echo "ğŸ“‹ Payload: ${{ steps.parse.outputs.json_payload }}"
          echo "ğŸ”— PR: #${{ github.event.issue.number }}"
          
      - name: Handle start-session
        if: steps.parse.outputs.command == 'start-session'
        run: |
          echo "ğŸš€ Starting bot session..."
          
          # Install jq if not available
          which jq || sudo apt-get update && sudo apt-get install -y jq
          
          # Create session file
          mkdir -p .bot-operations
          cat > .bot-operations/session.json << EOF
          {
            "session_id": "session-$(date +%s)",
            "started_by": "${{ github.actor }}",
            "started_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "pr_number": ${{ github.event.issue.number }},
            "payload": ${{ steps.parse.outputs.json_payload }},
            "status": "active",
            "operations": []
          }
          EOF
          
          echo "âœ… Session created:"
          cat .bot-operations/session.json | jq .
          
      - name: Handle approve
        if: steps.parse.outputs.command == 'approve'
        run: |
          echo "âœ… Processing approval..."
          
          # Install dependencies
          which jq || sudo apt-get update && sudo apt-get install -y jq
          
          # Parse operation from JSON payload
          PAYLOAD='${{ steps.parse.outputs.json_payload }}'
          
          if [[ "$PAYLOAD" != "{}" ]] && [[ "$PAYLOAD" != "" ]]; then
            echo "ğŸ“‹ Operation payload received:"
            echo "$PAYLOAD" | jq . || echo "$PAYLOAD"
            
            # Store approved operation
            mkdir -p .bot-operations
            echo "$PAYLOAD" > .bot-operations/approved-operation-$(date +%s).json
            
            echo "âœ… Operation approved and stored"
          else
            echo "âŒ No operation payload found in approval command"
          fi
          
      - name: Handle rollback
        if: steps.parse.outputs.command == 'rollback'
        run: |
          echo "â†©ï¸ Processing rollback request..."
          PAYLOAD='${{ steps.parse.outputs.json_payload }}'
          
          if [[ "$PAYLOAD" != "{}" ]] && [[ "$PAYLOAD" != "" ]]; then
            which jq && LAST_N=$(echo "$PAYLOAD" | jq -r '.last // 1') || LAST_N=1
            echo "Rolling back last $LAST_N operations"
            
            # List recent operations for rollback
            if [ -d ".bot-operations" ]; then
              echo "ğŸ“ Operations directory contents:"
              ls -la .bot-operations/
              echo "Rollback capability: READY (placeholder implementation)"
            else
              echo "No operations to rollback"
            fi
          else
            echo "Using default rollback (last 1 operation)"
          fi
          
      - name: Handle status
        if: steps.parse.outputs.command == 'status'
        run: |
          echo "ğŸ“Š Bot Operations Status"
          echo "======================"
          
          if [ -f ".bot-operations/session.json" ]; then
            echo "âœ… Active Session:"
            which jq && cat .bot-operations/session.json | jq . || cat .bot-operations/session.json
          else
            echo "âŒ No active session - use /start-session first"
          fi
          
          if [ -d ".bot-operations" ]; then
            echo ""
            echo "ğŸ“ Operations Directory:"
            ls -la .bot-operations/ | grep -E '\.(json)$' || echo "No operations found"
          fi
          
      - name: Comment response
        uses: actions/github-script@v6
        with:
          script: |
            const command = '${{ steps.parse.outputs.command }}';
            const actor = '${{ github.actor }}';
            const prNumber = '${{ github.event.issue.number }}';
            
            let responseBody = '';
            
            if (command === 'start-session') {
              responseBody = `ğŸ¤– **Bot Session Started**\n\nâœ… Session active for @${actor} in PR #${prNumber}\n\n**Available Commands:**\n- \`/approve {"files": [...], "action": "create|update|delete"}\` - Approve operation\n- \`/rollback {"last": 3}\` - Rollback operations\n- \`/bot-status\` - Show session status\n\n**Smart Auto-Approval:**\n- âœ… Documentation updates (*.md files)\n- âœ… Test additions (test_*.py)\n- âœ… Lint fixes and comments\n- âŒ Workflow changes (require approval)\n- âŒ File deletions (require approval)\n\nâ° Session expires in 1 hour.`;
            } else if (command === 'approve') {
              responseBody = `âœ… **Operation Approved**\n\nOperation queued for risk classification and execution.\n\n**Next:** Bot will analyze risk level and either:\n- ğŸš€ **Auto-execute** (if SAFE)\n- â³ **Show preview** and wait for confirmation (if RISKY)\n\nğŸ“ Check logs in Actions tab for detailed execution info.`;
            } else if (command === 'rollback') {
              responseBody = `â†©ï¸ **Rollback Processing**\n\nAnalyzing recent operations for rollback...\n\nğŸ“ Check Actions logs for operation history.\n\n**Note:** Full rollback execution coming in next update.`;
            } else if (command === 'status') {
              responseBody = `ğŸ“Š **Bot Status Report**\n\nğŸ”— **Session:** Check workflow logs for detailed status\nğŸ¤– **Commands:** Listening for /start-session, /approve, /rollback\nâš–ï¸ **Risk Classification:** Active\nğŸš€ **Auto-Approval:** Enabled for safe operations\n\nğŸ“ **Operations:** See Actions logs for audit trail`;
            } else {
              responseBody = `â“ **Unknown Command**\n\n**Available Commands:**\n- \`/start-session {"goal": "feature-name", "duration": "4h"}\`\n- \`/approve {"files": [...]}\`\n- \`/rollback {"last": 3}\`\n- \`/bot-status\`\n\n**Command received:** \`${{ github.event.comment.body }}\`\n**Parsed as:** \`${command}\``;
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: responseBody
            });