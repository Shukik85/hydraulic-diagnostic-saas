# infrastructure/istio/virtual-services.yaml
# Traffic routing и resilience policies
---
# API Gateway Virtual Service
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: api-gateway-vs
  namespace: hydraulic-prod
spec:
  hosts:
    - api-gateway.hydraulic-prod.svc.cluster.local
  http:
    - match:
        - uri:
            prefix: "/api/v1/auth"
      route:
        - destination:
            host: auth-service.hydraulic-prod.svc.cluster.local
            port:
              number: 8001
      timeout: 10s
      retries:
        attempts: 3
        perTryTimeout: 3s
        retryOn: 5xx,reset,connect-failure,refused-stream
    
    - match:
        - uri:
            prefix: "/api/v1/systems"
      route:
        - destination:
            host: equipment-service.hydraulic-prod.svc.cluster.local
            port:
              number: 8002
      timeout: 15s
      retries:
        attempts: 2
        perTryTimeout: 5s
    
    - match:
        - uri:
            prefix: "/api/v1/diagnosis"
      route:
        - destination:
            host: diagnosis-service.hydraulic-prod.svc.cluster.local
            port:
              number: 8003
      timeout: 120s  # Longer timeout для ML inference
      retries:
        attempts: 1  # No retries для expensive operations
---
# GNN Service Virtual Service
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: gnn-service-vs
  namespace: hydraulic-prod
spec:
  hosts:
    - gnn-service.hydraulic-prod.svc.cluster.local
  http:
    - route:
        - destination:
            host: gnn-service.hydraulic-prod.svc.cluster.local
            port:
              number: 8002
      timeout: 60s
      retries:
        attempts: 0  # No auto-retry для GPU-intensive tasks
