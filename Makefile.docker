# ===============================================================================
# Hydraulic Diagnostic SaaS - Docker Makefile with pip caching
# ===============================================================================
# Quick commands for optimized Docker workflow

.PHONY: help build build-fast build-clean up down logs status test reset cache-info

# Enable BuildKit for cache support
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

help: ## Show this help message
	@echo "ğŸš€ Hydraulic Diagnostic SaaS - Docker Commands"
	@echo "================================================"
	@echo "âš¡ All builds use pip caching for 10x speed improvement!"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# === BUILD COMMANDS ===
build: ## Build containers with cache (recommended for development)
	@echo "ğŸ”¨ Building with cache optimization..."
	docker-compose build

build-fast: ## Quick incremental build (fastest for code changes)
	@echo "âš¡ Quick incremental build..."
	docker-compose up --build -d

build-clean: ## Clean build without cache (slowest, use when dependencies change)
	@echo "ğŸ§½ Clean build without cache..."
	docker-compose build --no-cache

# === RUN COMMANDS ===
up: ## Start all services
	@echo "ğŸš€ Starting all services..."
	docker-compose up -d

down: ## Stop all services
	@echo "ğŸ—‘ï¸ Stopping all services..."
	docker-compose down

restart: ## Restart all services
	@echo "ğŸ”„ Restarting all services..."
	docker-compose down && docker-compose up -d

# === MONITORING COMMANDS ===
logs: ## Show backend logs
	docker-compose logs -f backend

logs-all: ## Show all services logs
	docker-compose logs -f

status: ## Show containers status
	@echo "ğŸ“Š Container Status:"
	docker-compose ps
	@echo ""
	@echo "ğŸ’¾ Disk Usage:"
	docker system df

# === DEVELOPMENT COMMANDS ===
shell: ## Access Django shell
	docker-compose exec backend python manage.py shell

bash: ## Access backend container bash
	docker-compose exec backend bash

django-check: ## Run Django system checks
	docker-compose exec backend python manage.py check --deploy --fail-level ERROR

migrate: ## Run database migrations
	docker-compose exec backend python manage.py migrate

makemigrations: ## Create new migrations
	docker-compose exec backend python manage.py makemigrations

superuser: ## Create Django superuser
	docker-compose exec backend python manage.py createsuperuser

# === TESTING COMMANDS ===
test: ## Run tests
	@echo "ğŸ§ª Running tests..."
	docker-compose exec backend python manage.py test

health: ## Check backend health
	@echo "ğŸ¯ Testing backend connectivity..."
	@curl -f http://localhost:8000/health/ && echo "âœ… Backend is healthy" || echo "âŒ Backend is not responding"

# === CLEANUP COMMANDS ===
reset: ## Full reset - stop, clean, rebuild (nuclear option)
	@echo "âš ï¸  FULL RESET - This will delete all data!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo ""; \
		echo "ğŸ—‘ï¸ Stopping containers..."; \
		docker-compose down -v; \
		echo "ğŸ§½ Cleaning up..."; \
		docker system prune -f; \
		echo "ğŸ”¨ Rebuilding..."; \
		docker-compose build; \
		echo "ğŸš€ Starting..."; \
		docker-compose up -d; \
	else \
		echo "\nReset cancelled."; \
	fi

clean-cache: ## Clear Docker cache (use carefully - will slow down next build)
	@echo "âš ï¸  This will clear pip cache and slow down next build!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo ""; \
		docker builder prune -af; \
		echo "âœ… Cache cleared"; \
	else \
		echo "\nCache cleanup cancelled."; \
	fi

# === CACHE INFO ===
cache-info: ## Show cache usage info
	@echo "ğŸ“Š Docker Cache Information:"
	@echo "============================="
	docker system df -v
	@echo ""
	@echo "ğŸ’¾ Builder Cache:"
	docker builder du

# === QUICK FIXES ===
fix-permissions: ## Fix file permissions (Linux/macOS)
	@echo "ğŸ”§ Fixing file permissions..."
	sudo chown -R $$USER:$$USER .
	chmod +x docker/entrypoint.sh

fix-spectacular: ## Fix DRF Spectacular errors
	@echo "ğŸš‘ Fixing DRF Spectacular errors..."
	docker-compose exec backend python manage.py fix_drf_spectacular_errors

# === PERFORMANCE TIPS ===
tips: ## Show performance optimization tips
	@echo "âš¡ Docker Performance Tips:"
	@echo "========================"
	@echo ""
	@echo "ğŸš€ FASTEST: Use 'make build-fast' for code changes"
	@echo "ğŸ”¨ NORMAL: Use 'make build' for most rebuilds"
	@echo "ğŸ§½ SLOWEST: Use 'make build-clean' only when dependencies change"
	@echo ""
	@echo "ğŸ’¾ Cache status: Run 'make cache-info' to see cache usage"
	@echo "ğŸ“ˆ First build: ~5-10 minutes"
	@echo "âš¡ Cached builds: ~30 seconds"
	@echo ""
	@echo "ğŸ”§ Available services after 'make up':"
	@echo "  - Backend API: http://localhost:8000"
	@echo "  - Django Admin: http://localhost:8000/admin (admin/admin123)"
	@echo "  - API Docs: http://localhost:8000/api/schema/swagger-ui/"
	@echo "  - Database: localhost:5432"
	@echo "  - Redis: localhost:6379"