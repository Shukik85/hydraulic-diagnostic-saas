openapi: 3.1.0
info:
  title: Hydraulic Diagnostic Platform API
  version: 1.0.0
  description: |
    Enterprise sensor data ingestion and ML anomaly detection API.
    
    ## Features
    - Real-time sensor data ingestion (Modbus, OPC UA, HTTP)
    - ML-powered anomaly detection (CatBoost, XGBoost, Ensemble)
    - TimescaleDB optimized time-series storage
    - Data quality management with quarantine workflow
    - Job status tracking and observability
    
    ## Performance
    - INSERT: >10K rows/second
    - API latency: <50ms p95
    - ML inference: <20ms (ONNX optimized)
    
  contact:
    name: Plotnikov Aleksandr
    email: shukik85@ya.ru
  license:
    name: Proprietary

servers:
  - url: http://localhost:8000/api/v1
    description: Development Server
  - url: https://api.hydraulic-platform.com/api/v1
    description: Production Server

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtained from /api/v1/auth/login endpoint.
        Include in Authorization header: `Bearer <token>`

  schemas:
    SensorReading:
      type: object
      required:
        - sensor_id
        - timestamp
        - value
        - unit
      properties:
        sensor_id:
          type: string
          format: uuid
          description: Unique sensor identifier
          example: "550e8400-e29b-41d4-a716-446655440001"
        timestamp:
          type: string
          format: date-time
          description: Sensor reading timestamp (ISO 8601 UTC)
          example: "2025-11-07T22:50:00Z"
        value:
          type: number
          format: float
          description: Numeric sensor measurement value
          example: 125.5
        unit:
          type: string
          enum:
            - bar
            - celsius
            - rpm
            - lpm
          description: Measurement unit
          example: "bar"
        quality:
          type: integer
          minimum: 0
          maximum: 100
          default: 100
          description: Data quality score (0-100%). Values <50 are quarantined.
          example: 95

    SensorBulkIngest:
      type: object
      required:
        - system_id
        - readings
      properties:
        system_id:
          type: string
          format: uuid
          description: Target hydraulic system UUID
          example: "550e8400-e29b-41d4-a716-446655440000"
        readings:
          type: array
          items:
            $ref: '#/components/schemas/SensorReading'
          minItems: 1
          maxItems: 10000
          description: Array of sensor readings (1-10,000 per request)

    IngestionJobStatus:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
          description: Unique job identifier
          example: "a8f5f167-0e07-4b0c-8e6a-3c3c3e3c3e3c"
        status:
          type: string
          enum:
            - queued
            - processing
            - completed
            - failed
          description: Current job status
          example: "completed"
        total_readings:
          type: integer
          minimum: 0
          description: Total number of readings in batch
          example: 1000
        inserted_readings:
          type: integer
          minimum: 0
          description: Successfully inserted readings
          example: 987
        quarantined_readings:
          type: integer
          minimum: 0
          description: Readings quarantined due to validation errors
          example: 13
        created_at:
          type: string
          format: date-time
          description: Job creation timestamp
          example: "2025-11-07T22:50:00Z"
        completed_at:
          type: string
          format: date-time
          nullable: true
          description: Job completion timestamp (null if not finished)
          example: "2025-11-07T22:50:05Z"
        error_message:
          type: string
          nullable: true
          description: Error message if job failed (null if successful)
          example: null
        processing_time_ms:
          type: integer
          nullable: true
          description: Total processing time in milliseconds
          example: 4523
        success_rate:
          type: number
          format: float
          minimum: 0.0
          maximum: 100.0
          description: Success rate as percentage
          example: 98.7
        system_id:
          type: string
          format: uuid
          description: Target system UUID
          example: "550e8400-e29b-41d4-a716-446655440000"

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
            - timestamp
          properties:
            code:
              type: string
              enum:
                - VALIDATION_ERROR
                - AUTHENTICATION_ERROR
                - RATE_LIMIT_EXCEEDED
                - INTERNAL_ERROR
                - ML_SERVICE_UNAVAILABLE
                - SYSTEM_NOT_FOUND
              description: Error code for programmatic handling
              example: "VALIDATION_ERROR"
            message:
              type: string
              description: Human-readable error message
              example: "Invalid sensor data: value out of range"
            details:
              type: object
              additionalProperties: true
              description: Detailed error information
              example:
                field: "value"
                reason: "Value 800 exceeds maximum 700 for unit 'bar'"
            timestamp:
              type: string
              format: date-time
              description: Error timestamp
              example: "2025-11-07T22:50:00Z"
            request_id:
              type: string
              format: uuid
              description: Request correlation ID for tracing
              example: "b8f5f167-0e07-4b0c-8e6a-3c3c3e3c3e3c"

paths:
  /data/ingest:
    post:
      summary: Bulk sensor data ingestion
      description: |
        Ingest batch of sensor readings from industrial protocols (Modbus, OPC UA, HTTP JSON).
        
        **Features:**
        - Async processing via Celery
        - Full validation (range, timestamp, quality)
        - Quarantine workflow for invalid data
        - Rate limiting: 15 requests/minute
        - Max batch size: 10,000 readings
        
        **Performance:**
        - API response: <50ms (202 Accepted)
        - Processing: >10K rows/second
        - TimescaleDB optimized storage
      operationId: ingestSensorData
      tags:
        - Data Ingestion
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SensorBulkIngest'
            example:
              system_id: "550e8400-e29b-41d4-a716-446655440000"
              readings:
                - sensor_id: "550e8400-e29b-41d4-a716-446655440001"
                  timestamp: "2025-11-07T22:50:00Z"
                  value: 125.5
                  unit: "bar"
                  quality: 95
                - sensor_id: "550e8400-e29b-41d4-a716-446655440002"
                  timestamp: "2025-11-07T22:50:01Z"
                  value: 65.2
                  unit: "celsius"
                  quality: 98
      responses:
        '202':
          description: |
            Accepted for processing. Job queued in Celery.
            Use job_id to track status via GET /jobs/{job_id}/
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                    format: uuid
                    example: "a8f5f167-0e07-4b0c-8e6a-3c3c3e3c3e3c"
                  status:
                    type: string
                    enum:
                      - queued
                      - processing
                    example: "queued"
        '400':
          description: Validation error (invalid data format, out of range values)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required (missing or invalid JWT token)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded (max 15 requests/minute)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/{job_id}/:
    get:
      summary: Get ingestion job status
      description: |
        Retrieve detailed status of a bulk ingestion job.
        
        **Job Lifecycle:**
        1. queued - Job accepted, waiting for Celery worker
        2. processing - Celery task is running
        3. completed - Successfully finished
        4. failed - Error during processing
        
        **Metrics Provided:**
        - Total, inserted, and quarantined reading counts
        - Success rate percentage
        - Processing time in milliseconds
        - Error message if failed
      operationId: getJobStatus
      tags:
        - Job Tracking
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          description: UUID of the ingestion job (returned from POST /data/ingest)
          schema:
            type: string
            format: uuid
          example: "a8f5f167-0e07-4b0c-8e6a-3c3c3e3c3e3c"
      responses:
        '200':
          description: Job status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionJobStatus'
              example:
                job_id: "a8f5f167-0e07-4b0c-8e6a-3c3c3e3c3e3c"
                status: "completed"
                total_readings: 1000
                inserted_readings: 987
                quarantined_readings: 13
                created_at: "2025-11-07T22:50:00Z"
                completed_at: "2025-11-07T22:50:05Z"
                error_message: null
                processing_time_ms: 4523
                success_rate: 98.7
                system_id: "550e8400-e29b-41d4-a716-446655440000"
        '400':
          description: Invalid job_id format (must be valid UUID)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

tags:
  - name: Data Ingestion
    description: Bulk sensor data ingestion from industrial protocols
  - name: Job Tracking
    description: Ingestion job status and monitoring
