{% extends "docs/base.html" %}
{% load static %}

{% block title %}{{ document.title }} - Documentation - {{ block.super }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<!-- Markdown rendering with syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
{% endblock %}

{% block docs_content %}
<div class="docs-breadcrumb">
    <a href="{% url 'docs:index' %}" class="docs-breadcrumb__link">Documentation</a>
    <span class="docs-breadcrumb__separator">/</span>
    <a href="{% url 'docs:category' document.category.slug %}" class="docs-breadcrumb__link">
        {{ document.category.name }}
    </a>
    <span class="docs-breadcrumb__separator">/</span>
    <span class="docs-breadcrumb__current">{{ document.title }}</span>
</div>

<article class="docs-article">
    <header class="docs-article__header">
        <div class="docs-article__meta">
            <span class="docs-article__category">
                {{ document.category.icon }} {{ document.category.name }}
            </span>
            <span class="docs-article__views">üëÅ {{ document.view_count }} views</span>
            <span class="docs-article__date">üìÖ Updated {{ document.updated_at|date:"M d, Y" }}</span>
        </div>
        <h1 class="docs-article__title">{{ document.title }}</h1>
        {% if document.summary %}
        <p class="docs-article__summary">{{ document.summary }}</p>
        {% endif %}
        {% if document.tags %}
        <div class="docs-article__tags">
            {% for tag in document.tag_list %}
            <span class="tag">{{ tag }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </header>

    <div class="docs-article__toolbar">
        <button 
            class="btn btn--secondary btn--sm" 
            id="markCompleteBtn"
            data-doc-slug="{{ document.slug }}"
            data-completed="{{ user_completed|yesno:'true,false' }}"
        >
            <span class="btn__icon">{{ user_completed|yesno:"‚úì,‚óã" }}</span>
            <span class="btn__text">{{ user_completed|yesno:"Completed,Mark as Complete" }}</span>
        </button>
        <button class="btn btn--secondary btn--sm" onclick="window.print()">
            <span class="btn__icon">üñ®</span>
            <span class="btn__text">Print</span>
        </button>
    </div>

    <div class="docs-article__content markdown-content" id="docContent">
        {{ document.content|safe }}
    </div>

    {% if document.author %}
    <footer class="docs-article__footer">
        <div class="docs-article__author">
            <strong>Author:</strong> {{ document.author.get_full_name|default:document.author.email }}
        </div>
    </footer>
    {% endif %}
</article>

{% if related_docs %}
<aside class="docs-related">
    <h3 class="docs-related__title">Related Documents</h3>
    <div class="docs-related__list">
        {% for related in related_docs %}
        <a href="{% url 'docs:detail' related.slug %}" class="docs-related__item">
            <span class="docs-related__icon">üìÑ</span>
            <span class="docs-related__title">{{ related.title }}</span>
        </a>
        {% endfor %}
    </div>
</aside>
{% endif %}
{% endblock %}

{% block extrajs %}
{{ block.super }}
<!-- Markdown parser -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<!-- Syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
// Parse Markdown content
const contentEl = document.getElementById('docContent');
if (contentEl) {
    const rawContent = contentEl.textContent;
    marked.setOptions({
        highlight: function(code, lang) {
            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
            return hljs.highlight(code, { language }).value;
        },
        breaks: true,
        gfm: true
    });
    contentEl.innerHTML = marked.parse(rawContent);
}

// Mark as complete functionality
const markCompleteBtn = document.getElementById('markCompleteBtn');
if (markCompleteBtn) {
    markCompleteBtn.addEventListener('click', async function() {
        const slug = this.dataset.docSlug;
        
        try {
            const response = await fetch(`/admin/docs/api/mark-complete/${slug}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.dataset.completed = data.completed ? 'true' : 'false';
                this.querySelector('.btn__icon').textContent = data.completed ? '‚úì' : '‚óã';
                this.querySelector('.btn__text').textContent = data.completed ? 'Completed' : 'Mark as Complete';
            }
        } catch (error) {
            console.error('Error marking complete:', error);
        }
    });
}
</script>
{% endblock %}
