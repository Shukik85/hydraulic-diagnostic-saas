# services/gnn_service/kubernetes/deployment.yaml
# Production Kubernetes deployment —Å GPU support
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gnn-service
  namespace: hydraulic-prod
  labels:
    app: gnn-service
    tier: ml-inference
    version: v1.0.0
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: gnn-service
  template:
    metadata:
      labels:
        app: gnn-service
        tier: backend
        version: v1.0.0
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8002"
        prometheus.io/path: "/metrics"
        sidecar.istio.io/inject: "true"
    spec:
      serviceAccountName: gnn-service
      
      # Anti-affinity: spread across zones
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - gnn-service
              topologyKey: topology.kubernetes.io/zone
      
      # GPU toleration
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
      
      # Init container: wait for TimescaleDB
      initContainers:
        - name: wait-for-db
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              until nc -z timescaledb.hydraulic-prod.svc.cluster.local 5432; do
                echo "Waiting for TimescaleDB..."
                sleep 2
              done
      
      containers:
        - name: gnn-service
          image: ghcr.io/shukik85/gnn-service:1.0.0-cuda12.8
          imagePullPolicy: Always
          
          ports:
            - containerPort: 8002
              name: http
              protocol: TCP
            - containerPort: 50051
              name: grpc
              protocol: TCP
          
          # Resource limits
          resources:
            requests:
              memory: "8Gi"
              cpu: "2000m"
              nvidia.com/gpu: "1"
            limits:
              memory: "16Gi"
              cpu: "4000m"
              nvidia.com/gpu: "1"
          
          # Environment variables
          env:
            - name: CUDA_VISIBLE_DEVICES
              value: "0"
            - name: MODEL_PATH
              value: "/models/universal_dynamic_best.ckpt"
            - name: ENVIRONMENT
              value: "production"
            - name: LOG_LEVEL
              value: "INFO"
            
            # Database credentials from secret
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: timescaledb-credentials
                  key: host
            - name: DB_PORT
              valueFrom:
                secretKeyRef:
                  name: timescaledb-credentials
                  key: port
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: timescaledb-credentials
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: timescaledb-credentials
                  key: password
            - name: DB_NAME
              value: "hydraulic_db"
            
            # JWT secret from secret
            - name: JWT_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: jwt-secret
                  key: secret-key
          
          # Volume mounts
          volumeMounts:
            - name: model-storage
              mountPath: /models
              readOnly: true
            - name: tmp
              mountPath: /tmp
            - name: tls-certs
              mountPath: /var/run/secrets/tls
              readOnly: true
          
          # Liveness probe
          livenessProbe:
            httpGet:
              path: /health
              port: 8002
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          
          # Readiness probe
          readinessProbe:
            httpGet:
              path: /ready
              port: 8002
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 2
          
          # Startup probe (for slow model loading)
          startupProbe:
            httpGet:
              path: /health
              port: 8002
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
      
      volumes:
        - name: model-storage
          persistentVolumeClaim:
            claimName: gnn-models-pvc
        - name: tmp
          emptyDir: {}
        - name: tls-certs
          secret:
            secretName: istio-tls-certs
---
apiVersion: v1
kind: Service
metadata:
  name: gnn-service
  namespace: hydraulic-prod
  labels:
    app: gnn-service
spec:
  type: ClusterIP
  selector:
    app: gnn-service
  ports:
    - name: http
      port: 8002
      targetPort: 8002
      protocol: TCP
    - name: grpc
      port: 50051
      targetPort: 50051
      protocol: TCP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gnn-models-pvc
  namespace: hydraulic-prod
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: efs-sc
  resources:
    requests:
      storage: 50Gi
